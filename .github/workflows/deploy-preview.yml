name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå°†æ¥ã®å®Ÿè£…ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
  deploy-preview:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment info
        id: deploy-info
        run: |
          echo "preview_url=https://pr-${{ github.event.pull_request.number }}.preview.real-estate-dx.dev" >> $GITHUB_OUTPUT
          echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT

      - name: Comment deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸš€ Preview Deployment
            
            | Status | Preview URL | Branch |
            |--------|-------------|--------|
            | â³ Pending | [${{ steps.deploy-info.outputs.preview_url }}](${{ steps.deploy-info.outputs.preview_url }}) | \`${{ steps.deploy-info.outputs.branch_name }}\` |
            
            > **Note**: Preview deployment is not yet configured. This is a placeholder for future implementation.
            
            ### Next Steps:
            1. Configure Google Cloud Build triggers
            2. Set up preview environment infrastructure
            3. Update this workflow with actual deployment steps
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # TODO: å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ã“ã«è¿½åŠ 
      # ä¾‹:
      # - name: Build Docker images
      #   run: ...
      # 
      # - name: Deploy to Google Cloud Run
      #   run: ...
      # 
      # - name: Run smoke tests
      #   run: ...

  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Cleanup resources
        run: |
          echo "ğŸ§¹ Cleaning up preview environment for PR #${{ github.event.pull_request.number }}"
          echo "TODO: Add actual cleanup steps here"
          
          # TODO: å®Ÿéš›ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ã“ã«è¿½åŠ 
          # ä¾‹:
          # - Google Cloud Runã®ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤
          # - Cloud SQLã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤
          # - Cloud Storageã®ä¸€æ™‚ãƒã‚±ãƒƒãƒˆå‰Šé™¤