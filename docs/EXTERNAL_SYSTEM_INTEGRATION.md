# å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºè¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025å¹´7æœˆ10æ—¥  
**æ›´æ–°æ—¥**: 2025å¹´7æœˆ10æ—¥  

---

## ğŸ“‹ æ¦‚è¦

### ç›®çš„
ä¸å‹•ç”£æ¥­ç•Œã®ä¸»è¦ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã«ã‚ˆã‚Šã€ç‰©ä»¶æƒ…å ±ã®è‡ªå‹•å–å¾—ãƒ»æ²è¼‰ãƒ»ç®¡ç†ã‚’å®Ÿç¾ã—ã€æ¥­å‹™åŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã€‚

### è¨­è¨ˆåŸå‰‡
1. **ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢**: å„ãƒ†ãƒŠãƒ³ãƒˆãŒç‹¬è‡ªã®èªè¨¼æƒ…å ±ã‚’ç®¡ç†
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: èªè¨¼æƒ…å ±ã®æš—å·åŒ–ä¿å­˜
3. **å¯ç”¨æ€§**: æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å¾©æ—§
4. **æ‹¡å¼µæ€§**: æ–°ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ ã®å®¹æ˜“ã•
5. **ç›£æŸ»**: å…¨æ“ä½œã®å®Œå…¨ãƒ­ã‚°è¨˜éŒ²

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Web Application                        â”‚
â”‚                 (External System Settings)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API Gateway                               â”‚
â”‚             (Authentication & Routing)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            External System Connector                       â”‚
â”‚                (Node.js + RPA)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚   REINS   â”‚   â”‚  AtHome   â”‚   â”‚ãƒãƒˆã‚µãƒ   â”‚
â”‚(Web RPA)  â”‚   â”‚(API+RPA)  â”‚   â”‚(Web RPA)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | è²¬å‹™ | æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ |
|--------------|------|-------------|
| External System Manager | å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ»è¨­å®š | TypeScript, React |
| Credential Manager | èªè¨¼æƒ…å ±æš—å·åŒ–ãƒ»ç®¡ç† | Node.js, crypto |
| RPA Engine | Webè‡ªå‹•åŒ–ãƒ»ãƒ‡ãƒ¼ã‚¿æŠ½å‡º | Puppeteer, Playwright |
| API Client | REST APIé€£æº | axios, fetch |
| Queue Manager | éåŒæœŸå‡¦ç†ãƒ»ãƒªãƒˆãƒ©ã‚¤ | Bull, Redis |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. èªè¨¼æƒ…å ±ç®¡ç†

#### æš—å·åŒ–ä»•æ§˜
```typescript
interface EncryptionConfig {
  algorithm: 'aes-256-gcm'
  keyLength: 32
  ivLength: 16
  tagLength: 16
}

interface EncryptedCredentials {
  iv: string              // åˆæœŸåŒ–ãƒ™ã‚¯ã‚¿ãƒ¼ (hex)
  authTag: string         // èªè¨¼ã‚¿ã‚° (hex)
  encryptedData: string   // æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ (hex)
  tenantId: string        // ãƒ†ãƒŠãƒ³ãƒˆID
  systemType: string      // ã‚·ã‚¹ãƒ†ãƒ ç¨®åˆ¥
}
```

#### ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚­ãƒ¼ç”Ÿæˆ
```typescript
class TenantKeyManager {
  private static generateTenantKey(tenantId: string): string {
    const masterKey = process.env.MASTER_ENCRYPTION_KEY!
    const salt = Buffer.from(tenantId + 'salt', 'utf8')
    
    return crypto.pbkdf2Sync(
      masterKey,
      salt,
      100000,    // iterations
      32,        // key length
      'sha256'   // hash function
    ).toString('hex')
  }
  
  static encryptForTenant(
    tenantId: string, 
    data: string
  ): EncryptedCredentials {
    const key = this.generateTenantKey(tenantId)
    const iv = crypto.randomBytes(16)
    const cipher = crypto.createCipher('aes-256-gcm', key)
    cipher.setAAD(Buffer.from(tenantId))
    
    let encrypted = cipher.update(data, 'utf8', 'hex')
    encrypted += cipher.final('hex')
    
    return {
      iv: iv.toString('hex'),
      authTag: cipher.getAuthTag().toString('hex'),
      encryptedData: encrypted,
      tenantId,
      systemType: 'external'
    }
  }
}
```

### 2. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- **èªè¨¼**: JWT + ãƒ†ãƒŠãƒ³ãƒˆIDæ¤œè¨¼
- **èªå¯**: RBAC (Role-Based Access Control)
- **ç›£æŸ»**: å…¨æ“ä½œãƒ­ã‚°è¨˜éŒ²
- **åˆ†é›¢**: ãƒ†ãƒŠãƒ³ãƒˆé–“å®Œå…¨åˆ†é›¢

---

## ğŸ“Š å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜

### 1. REINSï¼ˆæŒ‡å®šæµé€šæ©Ÿæ§‹ï¼‰

#### é€£æºä»•æ§˜
```typescript
interface REINSConnector {
  // åŸºæœ¬æƒ…å ±
  systemType: 'REINS'
  baseUrl: 'https://system.reins.or.jp'
  connectionType: 'WEB_SCRAPING'
  
  // èªè¨¼æƒ…å ±
  credentials: {
    username: string
    password: string
    organizationCode?: string
  }
  
  // æ©Ÿèƒ½
  functions: {
    login(): Promise<boolean>
    searchProperties(filters: PropertyFilters): Promise<Property[]>
    getPropertyDetails(propertyId: string): Promise<PropertyDetails>
    registerProperty(property: Property): Promise<RegisterResult>
    updateProperty(propertyId: string, updates: PropertyUpdate): Promise<UpdateResult>
    deleteProperty(propertyId: string): Promise<DeleteResult>
    logout(): Promise<void>
  }
}
```

#### RPAå®Ÿè£…
```typescript
class REINSRPAClient {
  private browser: Browser
  private page: Page
  
  async login(credentials: REINSCredentials): Promise<boolean> {
    try {
      await this.page.goto('https://system.reins.or.jp/login')
      
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
      await this.page.fill('#username', credentials.username)
      await this.page.fill('#password', credentials.password)
      
      if (credentials.organizationCode) {
        await this.page.fill('#orgCode', credentials.organizationCode)
      }
      
      // ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
      await this.page.click('#loginButton')
      
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç¢ºèª
      await this.page.waitForSelector('.dashboard', { timeout: 10000 })
      
      return true
    } catch (error) {
      this.logger.error('REINS login failed', { error })
      return false
    }
  }
  
  async searchProperties(filters: PropertyFilters): Promise<Property[]> {
    try {
      await this.page.goto('https://system.reins.or.jp/search')
      
      // æ¤œç´¢æ¡ä»¶è¨­å®š
      if (filters.priceMin) {
        await this.page.fill('#priceMin', filters.priceMin.toString())
      }
      if (filters.priceMax) {
        await this.page.fill('#priceMax', filters.priceMax.toString())
      }
      if (filters.area) {
        await this.page.selectOption('#area', filters.area)
      }
      
      // æ¤œç´¢å®Ÿè¡Œ
      await this.page.click('#searchButton')
      await this.page.waitForSelector('.property-list')
      
      // çµæœæŠ½å‡º
      const properties = await this.page.$$eval('.property-item', elements => {
        return elements.map(el => ({
          id: el.getAttribute('data-property-id'),
          title: el.querySelector('.title')?.textContent?.trim(),
          price: this.parsePrice(el.querySelector('.price')?.textContent),
          area: this.parseArea(el.querySelector('.area')?.textContent),
          address: el.querySelector('.address')?.textContent?.trim(),
          // ... other fields
        }))
      })
      
      return properties
    } catch (error) {
      this.logger.error('REINS search failed', { error, filters })
      throw error
    }
  }
}
```

### 2. AtHomeï¼ˆã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ï¼‰

#### é€£æºä»•æ§˜
```typescript
interface AtHomeConnector {
  systemType: 'ATHOME'
  baseUrl: 'https://api.athome.co.jp'
  connectionType: 'REST_API'
  
  credentials: {
    apiKey: string
    clientId: string
    clientSecret: string
  }
  
  functions: {
    authenticate(): Promise<AuthToken>
    getProperties(params: GetPropertiesParams): Promise<PropertyList>
    createProperty(property: Property): Promise<CreateResult>
    updateProperty(propertyId: string, updates: PropertyUpdate): Promise<UpdateResult>
    deleteProperty(propertyId: string): Promise<DeleteResult>
    uploadImage(propertyId: string, image: File): Promise<ImageUploadResult>
  }
}
```

#### APIå®Ÿè£…
```typescript
class AtHomeAPIClient {
  private baseUrl = 'https://api.athome.co.jp/v1'
  private authToken: string | null = null
  
  async authenticate(credentials: AtHomeCredentials): Promise<boolean> {
    try {
      const response = await fetch(`${this.baseUrl}/auth/token`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          client_id: credentials.clientId,
          client_secret: credentials.clientSecret,
          grant_type: 'client_credentials'
        })
      })
      
      const data = await response.json()
      this.authToken = data.access_token
      
      return !!this.authToken
    } catch (error) {
      this.logger.error('AtHome authentication failed', { error })
      return false
    }
  }
  
  async getProperties(params: GetPropertiesParams): Promise<PropertyList> {
    const url = new URL(`${this.baseUrl}/properties`)
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
    if (params.priceMin) url.searchParams.set('price_min', params.priceMin.toString())
    if (params.priceMax) url.searchParams.set('price_max', params.priceMax.toString())
    if (params.area) url.searchParams.set('area', params.area)
    if (params.limit) url.searchParams.set('limit', params.limit.toString())
    if (params.offset) url.searchParams.set('offset', params.offset.toString())
    
    const response = await fetch(url.toString(), {
      headers: {
        'Authorization': `Bearer ${this.authToken}`,
        'Content-Type': 'application/json',
      }
    })
    
    if (!response.ok) {
      throw new Error(`AtHome API error: ${response.status}`)
    }
    
    return await response.json()
  }
}
```

### 3. ãƒãƒˆã‚µãƒï¼ˆãƒãƒˆãƒãƒ¼ã‚¯ã‚µãƒãƒ¼ãƒˆï¼‰

#### é€£æºä»•æ§˜
```typescript
interface HatosapoConnector {
  systemType: 'HATOSAPO'
  baseUrl: 'https://www.hatosapo.jp'
  connectionType: 'WEB_SCRAPING'
  
  credentials: {
    username: string
    password: string
    companyCode?: string
  }
  
  functions: {
    login(): Promise<boolean>
    getPropertyList(): Promise<Property[]>
    postProperty(property: Property): Promise<PostResult>
    updateProperty(propertyId: string, updates: PropertyUpdate): Promise<UpdateResult>
    deleteProperty(propertyId: string): Promise<DeleteResult>
    uploadImages(propertyId: string, images: File[]): Promise<ImageUploadResult>
  }
}
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä»•æ§˜

### 1. åŒæœŸãƒ•ãƒ­ãƒ¼
```mermaid
graph TD
    A[å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ èªè¨¼] --> B[ãƒ‡ãƒ¼ã‚¿å–å¾—]
    B --> C[ãƒ‡ãƒ¼ã‚¿å¤‰æ›]
    C --> D[é‡è¤‡ãƒã‚§ãƒƒã‚¯]
    D --> E[ãƒ‡ãƒ¼ã‚¿çµ±åˆ]
    E --> F[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°]
    F --> G[åŒæœŸãƒ­ã‚°è¨˜éŒ²]
    G --> H[é€šçŸ¥é€ä¿¡]
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
```typescript
interface DataMapper {
  // REINS â†’ å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ 
  mapREINSProperty(reinsData: REINSProperty): InternalProperty
  
  // AtHome â†’ å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ 
  mapAtHomeProperty(athomeData: AtHomeProperty): InternalProperty
  
  // å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ  â†’ å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ 
  mapToREINS(internalData: InternalProperty): REINSProperty
  mapToAtHome(internalData: InternalProperty): AtHomeProperty
}

class PropertyDataMapper implements DataMapper {
  mapREINSProperty(reinsData: REINSProperty): InternalProperty {
    return {
      externalId: reinsData.propertyId,
      externalSystemType: 'REINS',
      title: reinsData.propertyName,
      price: this.parsePrice(reinsData.price),
      area: this.parseArea(reinsData.area),
      address: this.normalizeAddress(reinsData.address),
      propertyType: this.mapPropertyType(reinsData.category),
      description: reinsData.description,
      images: reinsData.images?.map(img => ({ url: img.url, caption: img.caption })),
      metadata: {
        reinsId: reinsData.propertyId,
        lastSyncAt: new Date().toISOString(),
        source: 'REINS'
      }
    }
  }
}
```

### 3. åŒæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
```typescript
interface SyncSchedule {
  // å®šæœŸåŒæœŸ
  fullSync: '0 2 * * *'      // æ¯æ—¥ 2:00
  incrementalSync: '*/30 * * * *'  // 30åˆ†ã”ã¨
  
  // ã‚¤ãƒ™ãƒ³ãƒˆåŒæœŸ
  onPropertyCreate: 'immediate'
  onPropertyUpdate: 'immediate'
  onPropertyDelete: 'immediate'
}

class SyncScheduler {
  async scheduleSync(tenantId: string, systemType: ExternalSystemType): Promise<void> {
    // Bull Queue ã§ã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    await this.syncQueue.add('fullSync', {
      tenantId,
      systemType,
      syncType: 'full'
    }, {
      repeat: { cron: '0 2 * * *' },
      attempts: 3,
      backoff: 'exponential'
    })
    
    await this.syncQueue.add('incrementalSync', {
      tenantId,
      systemType,
      syncType: 'incremental'
    }, {
      repeat: { cron: '*/30 * * * *' },
      attempts: 2,
      backoff: 'fixed'
    })
  }
}
```

---

## âš¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»å¾©æ—§

### 1. ã‚¨ãƒ©ãƒ¼åˆ†é¡
```typescript
enum ExternalSystemErrorType {
  AUTHENTICATION_ERROR = 'AUTHENTICATION_ERROR',    // èªè¨¼ã‚¨ãƒ©ãƒ¼
  NETWORK_ERROR = 'NETWORK_ERROR',                   // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
  RATE_LIMIT_ERROR = 'RATE_LIMIT_ERROR',            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼
  DATA_FORMAT_ERROR = 'DATA_FORMAT_ERROR',          // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼
  SYSTEM_MAINTENANCE = 'SYSTEM_MAINTENANCE',        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
  UNKNOWN_ERROR = 'UNKNOWN_ERROR'                   // ä¸æ˜ãªã‚¨ãƒ©ãƒ¼
}

interface ExternalSystemError {
  type: ExternalSystemErrorType
  message: string
  details?: Record<string, any>
  retryable: boolean
  retryAfter?: number
}
```

### 2. å¾©æ—§æˆ¦ç•¥
```typescript
class ErrorRecoveryStrategy {
  async handleError(error: ExternalSystemError, context: ErrorContext): Promise<RecoveryAction> {
    switch (error.type) {
      case ExternalSystemErrorType.AUTHENTICATION_ERROR:
        return this.handleAuthenticationError(error, context)
      
      case ExternalSystemErrorType.NETWORK_ERROR:
        return this.handleNetworkError(error, context)
      
      case ExternalSystemErrorType.RATE_LIMIT_ERROR:
        return this.handleRateLimitError(error, context)
      
      case ExternalSystemErrorType.SYSTEM_MAINTENANCE:
        return this.handleMaintenanceError(error, context)
      
      default:
        return this.handleUnknownError(error, context)
    }
  }
  
  private async handleAuthenticationError(error: ExternalSystemError, context: ErrorContext): Promise<RecoveryAction> {
    // èªè¨¼æƒ…å ±ã®å†æ¤œè¨¼
    const credentials = await this.getCredentials(context.tenantId, context.systemType)
    const testResult = await this.testConnection(credentials)
    
    if (!testResult.success) {
      // ç®¡ç†è€…ã«é€šçŸ¥
      await this.notificationService.sendAlert({
        tenantId: context.tenantId,
        type: 'EXTERNAL_SYSTEM_AUTH_FAILED',
        message: `${context.systemType} èªè¨¼ã‚¨ãƒ©ãƒ¼: èªè¨¼æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„`,
        severity: 'HIGH'
      })
      
      return { action: 'PAUSE', retryAfter: 3600 } // 1æ™‚é–“å¾Œã«å†è©¦è¡Œ
    }
    
    return { action: 'RETRY', retryAfter: 60 } // 1åˆ†å¾Œã«å†è©¦è¡Œ
  }
  
  private async handleNetworkError(error: ExternalSystemError, context: ErrorContext): Promise<RecoveryAction> {
    const backoffTime = Math.min(300, 30 * Math.pow(2, context.retryCount)) // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
    
    return { action: 'RETRY', retryAfter: backoffTime }
  }
}
```

### 3. ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
```typescript
interface SystemHealthMonitor {
  checkConnectionStatus(tenantId: string, systemType: ExternalSystemType): Promise<ConnectionStatus>
  recordMetrics(tenantId: string, systemType: ExternalSystemType, metrics: SystemMetrics): Promise<void>
  triggerAlert(alert: SystemAlert): Promise<void>
}

interface SystemMetrics {
  responseTime: number
  successRate: number
  errorRate: number
  lastSyncTime: Date
  syncedRecords: number
  failedRecords: number
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆä»•æ§˜

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ
```typescript
describe('ExternalSystemConnector', () => {
  describe('REINS Connector', () => {
    it('should authenticate successfully with valid credentials', async () => {
      const connector = new REINSConnector()
      const credentials = { username: 'test', password: 'test' }
      
      const result = await connector.authenticate(credentials)
      
      expect(result).toBe(true)
    })
    
    it('should handle authentication failure gracefully', async () => {
      const connector = new REINSConnector()
      const credentials = { username: 'invalid', password: 'invalid' }
      
      const result = await connector.authenticate(credentials)
      
      expect(result).toBe(false)
    })
    
    it('should extract property data correctly', async () => {
      const connector = new REINSConnector()
      const mockData = createMockREINSData()
      
      const properties = await connector.extractPropertyData(mockData)
      
      expect(properties).toHaveLength(10)
      expect(properties[0]).toHaveProperty('id')
      expect(properties[0]).toHaveProperty('title')
      expect(properties[0]).toHaveProperty('price')
    })
  })
})
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ
```typescript
describe('External System Integration', () => {
  it('should sync properties from REINS to internal system', async () => {
    const tenantId = 'test-tenant'
    const systemType = 'REINS'
    
    // å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶š
    const connector = await getConnector(tenantId, systemType)
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    const externalProperties = await connector.getProperties()
    
    // å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«åŒæœŸ
    const syncResult = await syncService.syncProperties(tenantId, externalProperties)
    
    expect(syncResult.success).toBe(true)
    expect(syncResult.syncedCount).toBeGreaterThan(0)
  })
})
```

### 3. E2Eãƒ†ã‚¹ãƒˆ
```typescript
describe('External System E2E', () => {
  it('should complete full property sync workflow', async () => {
    // 1. èªè¨¼æƒ…å ±è¨­å®š
    await page.goto('/settings/external-systems')
    await page.fill('#reins-username', 'test-user')
    await page.fill('#reins-password', 'test-password')
    await page.click('#save-credentials')
    
    // 2. æ¥ç¶šãƒ†ã‚¹ãƒˆ
    await page.click('#test-connection')
    await page.waitForSelector('.connection-success')
    
    // 3. åŒæœŸå®Ÿè¡Œ
    await page.click('#sync-properties')
    await page.waitForSelector('.sync-complete')
    
    // 4. çµæœç¢ºèª
    const syncedCount = await page.textContent('.synced-count')
    expect(parseInt(syncedCount)).toBeGreaterThan(0)
  })
})
```

---

## ğŸ“Š é‹ç”¨ãƒ»ç›£è¦–

### 1. é‹ç”¨æŒ‡æ¨™
```typescript
interface OperationMetrics {
  // æ¥ç¶šçŠ¶æ³
  connectionUptime: number        // æ¥ç¶šç¨¼åƒç‡
  authenticationSuccessRate: number // èªè¨¼æˆåŠŸç‡
  
  // åŒæœŸæ€§èƒ½
  syncFrequency: number          // åŒæœŸé »åº¦
  syncLatency: number            // åŒæœŸé…å»¶
  syncThroughput: number         // åŒæœŸã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
  
  // ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ
  errorRate: number              // ã‚¨ãƒ©ãƒ¼ç‡
  errorTypes: Record<string, number> // ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥çµ±è¨ˆ
  
  // ãƒ‡ãƒ¼ã‚¿å“è³ª
  dataAccuracy: number           // ãƒ‡ãƒ¼ã‚¿ç²¾åº¦
  duplicateRate: number          // é‡è¤‡ç‡
}
```

### 2. ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```typescript
interface MonitoringDashboard {
  // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
  systemStatus: {
    reins: 'ONLINE' | 'OFFLINE' | 'MAINTENANCE'
    athome: 'ONLINE' | 'OFFLINE' | 'MAINTENANCE'
    hatosapo: 'ONLINE' | 'OFFLINE' | 'MAINTENANCE'
  }
  
  // åŒæœŸçŠ¶æ³
  syncStatus: {
    lastSyncTime: Date
    nextSyncTime: Date
    syncedRecords: number
    failedRecords: number
  }
  
  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  performance: {
    avgResponseTime: number
    successRate: number
    errorRate: number
  }
}
```

---

## ğŸ”„ æ›´æ–°ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 1. ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°æ‰‹é †
1. **ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®æ¤œè¨¼**
2. **æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ**
3. **æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨**
4. **ç›£è¦–ãƒ»ç¢ºèª**

### 2. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨ˆç”»
- **å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**: æ¯æœˆç¬¬3åœŸæ›œæ—¥ 2:00-4:00
- **ç·Šæ€¥ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**: éšœå®³ç™ºç”Ÿæ™‚éšæ™‚
- **ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°**: å››åŠæœŸã”ã¨

---

## ğŸ“‹ ä»˜éŒ²

### A. å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸
å„å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ä»•æ§˜ãƒ»APIä»•æ§˜æ›¸ã¯åˆ¥é€”ç®¡ç†

### B. ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§
```typescript
enum ExternalSystemErrorCode {
  // èªè¨¼ã‚¨ãƒ©ãƒ¼
  AUTH_001 = 'Invalid credentials',
  AUTH_002 = 'Authentication timeout',
  AUTH_003 = 'Account locked',
  
  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
  NET_001 = 'Connection timeout',
  NET_002 = 'DNS resolution failed',
  NET_003 = 'SSL certificate error',
  
  // ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼
  DATA_001 = 'Invalid data format',
  DATA_002 = 'Missing required fields',
  DATA_003 = 'Data size limit exceeded'
}
```

### C. è¨­å®šé …ç›®ä¸€è¦§
```typescript
interface ExternalSystemConfig {
  timeout: number                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆç§’ï¼‰
  retryCount: number            // ãƒªãƒˆãƒ©ã‚¤å›æ•°
  retryInterval: number         // ãƒªãƒˆãƒ©ã‚¤é–“éš”ï¼ˆç§’ï¼‰
  batchSize: number             // ãƒãƒƒãƒå‡¦ç†ã‚µã‚¤ã‚º
  rateLimitRequests: number     // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†ï¼‰
  syncSchedule: string          // åŒæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆcronå½¢å¼ï¼‰
}
```

---

**æ‰¿èªè€…**: ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆè²¬ä»»è€…  
**æ‰¿èªæ—¥**: 2025å¹´7æœˆ10æ—¥