### **アーキテクチャ方針 v1.1**

**文書ID:** `ARC-005`
**文書名:** `メトリクス収集方針`

| Ver | 日付 | 作成 / 変更者 | 変更概要 |
|-----|------|---------------|----------|
| 1.0 | 2025-06-30 | システム管理者 | 初版作成 |
| 1.1 | 2025-06-30 | システム管理者 | バージョン管理追加、SLO/SLA数値設定 |

---

### 1. はじめに

システムの安定稼働、パフォーマンスの維持・向上、そしてビジネスの成長をデータに基づいて判断するためには、システムの様々な活動を定量的に計測・可視化する「メトリクス」の収集が不可欠である。

場当たり的にメトリクスを収集すると、監視ダッシュボードが乱立し、本当に重要な指標が埋もれてしまう。本ドキュメントは、本システムで収集するメトリクスの種類、命名規則、および技術スタックに関する基本方針を定め、効果的かつ効率的な監視体制を構築することを目的とする。

### 2. 技術スタック

メトリクスの収集、保存、可視化には、以下の業界標準の組み合わせを採用することを推奨する。

- **収集・保存:** **Prometheus**
  - 時系列データベースとして、メトリクスの収集と保存に特化。Pull型の収集モデルが特徴。
- **可視化・アラート:** **Grafana**
  - Prometheusに格納されたデータをクエリ（PromQL）し、柔軟でインタラクティブなダッシュボードを構築する。アラート設定も可能。
- **アプリケーションからの公開:** 各アプリケーションは、Prometheusがメトリクスを収集（スクレイプ）できるよう、`/metrics`のようなHTTPエンドポイントを公開する。

### 3. メトリクスの命名規則

一貫性のある命名規則は、メトリクスの発見と理解を容易にする。本システムでは以下の規則を推奨する。

`realsite_{subsystem}_{name}_{unit}`

- **`realsite_`**: アプリケーション全体を示す接頭辞。
- **`{subsystem}`**: メトリクスが属するサブシステム（例: `api`, `rpa`, `db`, `jobs`）。
- **`{name}`**: メトリクスの内容を示す名前（例: `http_requests_total`, `latency_seconds`）。
- **`{unit}`**: 単位。`_total` (カウンタ), `_seconds` (秒), `_bytes` (バイト), `_info` (情報) など。

**ラベルの活用:**
- `http_requests_total{method="POST", endpoint="/api/v1/properties", status="201"}` のように、Prometheusのラベル機能を用いて、メトリクスをさらに多次元的に分析できるようにする。

### 4. 収集する主要メトリクス

収集すべきメトリクスを、以下の4つのカテゴリに分類する。

#### 4.1. システムメトリクス (Node Exporter)

サーバーインスタンス自体の健全性を測る基本的なメトリクス。Node Exporterを各インスタンスに導入して収集する。

- `node_cpu_seconds_total`: CPU使用率
- `node_memory_MemAvailable_bytes`: 利用可能なメモリ量
- `node_filesystem_avail_bytes`: ディスク空き容量
- `node_network_receive_bytes_total`, `node_network_transmit_bytes_total`: ネットワーク送受信量

#### 4.2. APIサーバーメトリクス (RED Method)

APIのパフォーマンスと信頼性を測るための3つの主要な指標。

- **Rate (R):** リクエストレート
  - `realsite_api_http_requests_total`: エンドポイント、HTTPメソッド、ステータスコード別のリクエスト総数。
- **Errors (E):** エラーレート
  - 上記メトリクスのうち、`status`ラベルが`5xx`のものの割合。
- **Duration (D):** 処理時間
  - `realsite_api_http_request_duration_seconds`: リクエスト処理時間のヒストグラムまたはサマリー。パーセンタイル（95th, 99th）でレイテンシを監視する。

#### 4.3. バックグラウンドジョブメトリクス

非同期で実行されるタスク（OCR処理、RPA実行など）の状態を監視する。

- `realsite_jobs_active`: 現在実行中のジョブ数。
- `realsite_jobs_waiting`: キューで待機中のジョブ数。
- `realsite_job_duration_seconds`: ジョブタイプごとの処理時間のヒストグラム。
- `realsite_jobs_total{type="ocr", status="success"}`: ジョブタイプと結果（成功/失敗）別のジョブ総数。

#### 4.4. ビジネス・アプリケーションメトリクス

システムの利用状況や、ビジネス上のKPIを計測する。

- `realsite_users_registered_total`: 新規登録テナント数・ユーザー数。
- `realsite_documents_generated_total{type="contract"}`: 生成された帳票の種別ごとの総数（契約書、物件概要書など）。
- `realsite_external_integrations_total{target="reins", status="failed"}`: 外部システム連携の対象・結果ごとの総数。
- `realsite_ai_features_used_total{feature="comment_assist"}`: AI機能の利用回数。
- `realsite_database_connections{state="active"}`: データベースの接続数。

これらのメトリクスを収集・可視化することで、システム全体の健全性を多角的に把握し、問題の早期発見や将来のキャパシティプランニングに役立てる。

### 5. SLO/SLA（Service Level Objectives/Agreements）

収集したメトリクスに基づき、以下のサービス品質目標を設定する。

#### 5.1. API パフォーマンス SLO

| メトリクス | 目標値 | 計測期間 | 対象範囲 |
|-----------|--------|----------|----------|
| **レスポンスタイム（95th percentile）** | **500ms以内** | 月次 | 全APIエンドポイント（外部API除く） |
| **レスポンスタイム（99th percentile）** | **2秒以内** | 月次 | 全APIエンドポイント（外部API除く） |
| **可用性（Availability）** | **99.9%以上** | 月次 | システム全体 |
| **エラー率** | **0.1%以下** | 月次 | 4xx/5xxエラー率 |

#### 5.2. インフラストラクチャ SLO

| メトリクス | 目標値 | 対象 | 対応アクション |
|-----------|--------|------|----------------|
| **CPU使用率** | **80%以下** | 全コンピューティングインスタンス | 80%超過時はスケールアウト |
| **メモリ使用率** | **85%以下** | 全コンピューティングインスタンス | 85%超過時はスケールアウト |
| **ディスク使用率** | **90%以下** | データベース・ストレージ | 90%超過時は容量拡張 |

#### 5.3. ビジネス SLA（顧客向け）

| サービス | 目標値 | 補償/対応 |
|----------|--------|-----------|
| **システム稼働率** | **99.5%以上** | 月次稼働率99.5%未満の場合、利用料金の10%返金 |
| **データ復旧時間（RTO）** | **4時間以内** | 障害発生から4時間以内にサービス復旧 |
| **データ損失許容（RPO）** | **1時間以内** | 最大1時間前のデータ状態まで復旧保証 |

#### 5.4. アラート設定

| 条件 | 重要度 | 通知先 | 対応時間 |
|------|--------|--------|----------|
| **API レスポンスタイム > 1秒（5分継続）** | Warning | 開発チーム | 1時間以内 |
| **API レスポンスタイム > 5秒（1分継続）** | Critical | 開発チーム + 運用チーム | 15分以内 |
| **エラー率 > 5%（3分継続）** | Critical | 全チーム | 即座 |
| **システム可用性 < 99%（10分継続）** | Critical | 全チーム + 経営陣 | 即座 | 