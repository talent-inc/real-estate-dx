### **機能仕様書 v1.2**

**機能ID:** `AUTH-001`
**機能名:** `ユーザー認証・ログイン機能`

| Ver | 日付 | 作成 / 変更者 | 変更概要 |
|-----|------|---------------|----------|
| 1.0 | 2025-06-30 | システム管理者 | 初版作成 |
| 1.1 | 2025-06-30 | システム管理者 | RBAC詳細化、MFA対応追加 |
| 1.2 | 2025-06-30 | システム管理者 | バージョン管理追加、Token Storage方針明記 |

#### **1. 概要（Overview）**

本システムへのアクセスを制御し、正当な権限を持つユーザーのみが利用できるよう認証・認可を行う基本的なセキュリティ機能。企業の管理者ユーザーが、自社の従業員アカウントを発行・管理する機能も含む。

#### **2. ユーザーゴール（User Story）**

- **一般ユーザーとして、** 私は **安全にシステムにログイン・ログアウトしたい。** それによって、**自分の情報や顧客情報を保護したい。**
- **管理者ユーザーとして、** 私は **従業員のアクセス権を管理したい。** それによって、**組織のセキュリティポリシーを維持し、不正アクセスを防ぎたい。**

#### **3. 受入基準（Acceptance Criteria）**

- **ログイン/ログアウト:**
  - `[ ]` ユーザーは、メールアドレスとパスワードでログインできる。
  - `[ ]` 【MFA】ログイン時に、Time-based OTP (Google Authenticatorなど) または WebAuthn (FIDO2) による多要素認証を必須とすることができる。
  - `[ ]` 【SSO】オプションとして、OIDC (OpenID Connect) プロバイダー経由でのシングルサインオンをサポートする。
  - `[ ]` ログイン成功後、案件ダッシュボード(DSH-001)にリダイレクトされる。
  - `[ ]` ログイン失敗時、適切なエラーメッセージ（例：「メールアドレスまたはパスワードが正しくありません」）が表示される。
  - `[ ]` **5回**連続でログインに失敗したアカウントは、**15分間**一時的にロックされる。
  - `[ ]` ユーザーは、セッションを安全に終了させるためのログアウトボタンを利用できる。
- **パスワード管理:**
  - `[ ]` パスワードは、大文字、小文字、数字、記号を含む最低10文字以上の強度要件を満たす必要がある。
  - `[ ]` ユーザーは、パスワードを忘れた場合に、メール経由で再設定フローを開始できる。
- **ユーザー管理（管理者向け）:**
  - `[ ]` 管理者権限を持つユーザーは、自社の従業員アカウントを新規作成、編集、無効化できる。
  - `[ ]` 管理者は、ユーザーの役割（例：一般、管理者）を設定できる。
  - `[ ]` 【セキュリティ】外部パートナー（提携士業など）向けに、IPアドレス制限や有効期限付きのアカウントを発行できる。
- **セッション管理:**
  - `[ ]` ユーザーが一定時間操作を行わなかった場合、セッションは自動的にタイムアウトし、再ログインが要求される。
  - `[ ]` ユーザーのセッション情報は、サーバーサイドで安全に管理される。

#### **4. UIデザインとUXフロー**

- **4.1. 画面デザイン:**
  - ログイン画面、パスワード再設定画面、ユーザー管理画面のモックアップを定義する。
  - **[Figmaモックアップへのリンク（※作成後、ここにURLを記載）]**
- **4.2. ユーザーフロー図:**
  - **ログイン:** `ログイン画面` → `認証処理` → `成功時: ダッシュボード` / `失敗時: エラー表示`
  - **パスワード再設定:** `パスワード再設定要求画面` → `メール送信` → `メール内のリンクをクリック` → `新パスワード設定画面` → `設定完了`
  - **ユーザー作成:** `ユーザー管理画面` → `「新規作成」ボタン` → `ユーザー情報入力フォーム` → `作成完了`

#### **5. セキュリティ要件**

- `[ ]` パスワードは、ハッシュ化（Bcryptなど）してデータベースに保存する。平文では保存しない。
- `[ ]` **【パスワードポリシー】**
  - `[ ]` **有効期限:** パスワードの有効期限は**90日**とし、期限が近づいたユーザーにはUI上で通知を行う。
  - `[ ]` **履歴:** 過去**3世代**までパスワード履歴を保持し、同一パスワードへの再変更を禁止する。
- `[ ]` **【トークンストレージ方針】**
  - `[ ]` **JWT保存方式:** SPAフロントエンドからバックエンドへのアクセス用JWTは、XSS攻撃を防ぐため**HttpOnly Cookie**に保存する。LocalStorageには保存しない。
  - `[ ]` **CSRF対策:** CookieにはSameSite=Strict属性を設定し、CSRF攻撃を防止する。
  - `[ ]` **PKCEフロー:** OAuth 2.0認証時はPKCE (Proof Key for Code Exchange) フローを使用し、認証コードの盗取を防止する。
- `[ ]` **【セッション管理】**
  - `[ ]` **アイドルタイムアウト:** ユーザーが**30分間**無操作だった場合、セッションは自動的に無効となり、再ログインが要求される。
  - `[ ]` **絶対タイムアウト:** ログインからの経過時間が**8時間**を超えた場合、操作の有無にかかわらずセッションは無効となり、再ログインが要求される。
- `[ ]` ログイン、ログアウト、パスワード変更などの主要な認証イベントは、監査ログに記録される。

#### **6. パフォーマンス要件**

- `[ ]` ログイン要求に対するサーバーの応答時間は、95パーセンタイルで500ms未満であること。

#### **7. ロールベースアクセスコントロール（RBAC）**

本システムは、以下の役割（ロール）に基づいて機能へのアクセスを制御する。各機能仕様書は、そこで定義される操作を実行するために必要なロールを本セクションに準拠して指定する。

| ロールID | ロール名 | 主な責務 |
| :--- | :--- | :--- |
| `super_admin` | 最高管理者 | システム全体の管理、テナント管理、システム設定の変更。 |
| `tenant_admin` | 企業管理者 | 自社組織のユーザーアカウント管理、役割付与、組織設定の変更。 |
| `broker_agent` | 仲介担当者 | 物件情報の登録・編集、顧客管理、案件管理、帳票作成。 |
| `legal_staff` | 法務・契約担当 | 契約書・重要事項説明書の確認・承認、法令関連機能へのアクセス。 |
| `viewer` | 閲覧者 | 割り当てられた情報の閲覧のみ。編集・操作は不可。 |
| `external_partner` | 外部協力者 | 案件に招待された外部の協力者（士業など）。アクセスは特定の情報に限定される。 |

#### **8. エラーハンドリング**

| エラーケース | ユーザーへの表示（フロントエンド） | システムの挙動（バックエンド） |
| :--- | :--- | :--- |
| **存在しないメールアドレスでのログイン** | 「メールアドレスまたはパスワードが正しくありません」 | ユーザー名が存在しないことを特定させないため、パスワード間違いの場合と同じメッセージを返す。 |
| **パスワード再設定トークンの有効期限切れ** | 「このパスワード再設定リンクは無効です。もう一度やり直してください。」 | トークンの有効性を検証し、無効な場合はエラーを返す。 |
| **権限のない操作の実行** | 「この操作を行う権限がありません。」 | APIは権限エラー（ステータスコード403 Forbidden）を返す。 |