### **機能仕様書 v1.1**

**機能ID:** `CRM-001`
**機能名:** `軽量CRM（顧客管理・追客）機能`

#### **1. 概要（Overview）**

案件に紐づく顧客（売主、買主候補など）とのコミュニケーション履歴や、営業活動の進捗（追客状況）を記録・管理するためのシンプルな顧客関係管理（CRM）機能。本格的なCRMシステムのような多機能性は目指さず、不動産売買仲介業務に必要な最低限の機能に絞ることで、誰でも直感的に使える「軽量さ」を重視する。

#### **2. ユーザーゴール（User Story）**

**`broker_agent`（仲介担当者）ロールを持つユーザーとして、** 私は **どの顧客に、いつ、どんなアプローチをしたか、次に何をすべきかを簡単に記録・確認したい。** それによって、**顧客への対応漏れや二重アプローチを防ぎ、きめ細やかなフォローアップを実現したい。**

#### **3. 受入基準（Acceptance Criteria）**

- `[ ]` **【顧客データベース】** 全ての取引関係者（売主、買主、問い合わせ客など）の情報が、顧客データベースとして一元管理される。
- `[ ]` **【活動履歴の記録】** 各顧客の詳細画面で、コミュニケーション履歴（例：「電話」「メール」「訪問」「反響」）を時系列で記録できる。
- `[ ]` 活動履歴には、対応日時、対応者、具体的なやり取りの内容をメモとして残せる。
- `[ ]` **【タスク管理】** 将来のアクション（例：「3日後に状況確認の電話」「物件資料を送付」）を、「次のタスク」として期日付きで設定できる。
- `[ ]` **【ダッシュボード連携】** 設定された「次のタスク」のうち、期日が迫っているものが案件ダッシュボード(DSH-001)に通知・表示される。
- `[ ]` 顧客名や電話番号、対応状況などで顧客を検索・フィルタリングできる。
- `[ ]` 案件と顧客が紐づけられ、案件詳細画面から関連する顧客情報や活動履歴へスムーズにアクセスできる。

#### **4. UIデザインとUXフロー**

- **4.1. 画面デザイン:**
  - **顧客一覧画面:** 登録されている顧客をリスト形式で表示。検索・フィルタリング機能を提供。
  - **顧客詳細画面:**
    - 上部に顧客の基本情報（氏名、連絡先など）。
    - 下部に活動履歴と次のタスクを時系列で表示するタイムライン形式のUI。
    - 活動履歴を簡単に追加するための入力フォーム。
  - **[Figmaモックアップへのリンク（※作成後、ここにURLを記載）]**
- **4.2. ユーザーフロー図:**
  1. メインメニューから「顧客管理」を選択し、顧客一覧画面へ。
  2. 顧客を選択、または新規登録し、顧客詳細画面へ遷移。
  3. 「活動履歴を追加」ボタンから、電話対応の内容などを記録する。
  4. 同時に「次のタスク」として、フォローアップの電話を3日後の日付で設定する。
  5. 3日後、担当者の案件ダッシュボードに、そのタスクが表示される。

#### **5. システム要件（バックエンド）**

- **5.1. APIエンドポイント:**
  - `GET /api/v1/customers` (顧客一覧の取得)
  - `POST /api/v1/customers` (新規顧客の登録)
  - `GET /api/v1/customers/{customer_id}` (顧客詳細情報の取得)
  - `POST /api/v1/customers/{customer_id}/activities` (活動履歴の追加)
  - `POST /api/v1/customers/{customer_id}/tasks` (タスクの追加)
- **5.2. データモデル:**
  - `customers`テーブル: 顧客の基本情報を格納。
  - `activities`テーブル: 顧客への対応履歴を格納。`customer_id`で顧客と紐づく。
  - `tasks`テーブル: 未来のアクションを格納。`customer_id`や`property_id`で関連付けられる。
- **5.3. 連携ロジック:**
  - タスクの期日が近づいたことを検知するバッチ処理を夜間などに実行し、ダッシュボードに表示するための通知データを作成する。

#### **6. エラーハンドリング**

| エラーケース | ユーザーへの表示（フロントエンド） | システムの挙動（バックエンド） |
| :--- | :--- | :--- |
| **必須項目（顧客名など）の不足** | 「顧客名の入力は必須です。」 | フロントエンドおよびバックエンドでバリデーションを行い、保存をブロックする。 |
| **データの保存失敗** | 「情報の保存に失敗しました。時間をおいて再度お試しください。」 | APIはエラーステータス（500）を返し、エラー内容をログに記録する。 |

#### **7. データ管理とプライバシー**

本機能で扱う顧客情報は個人情報を含むため、日本の個人情報保護法に基づき、以下のデータ管理ポリシーを定める。

- `[ ]` **【PIIの定義】** 氏名、住所、電話番号、メールアドレスなど、特定の個人を識別できる情報を個人識別情報（PII）として扱う。
- `[ ]` **【データ保持期間】** 顧客データの保持期間は、以下のいずれかの条件を満たした時点から**原則5年間**とする。
  - 最後の活動履歴（電話、メール等）が記録された日
  - 関連する案件が「成約」ステータスになった日
- `[ ]` **【保持期間経過後の措置】** 保持期間を経過した顧客データは、システムによって自動的に「要対応」フラグが付与される。
  - `[ ]` `tenant_admin`（企業管理者）ロールを持つユーザーは、管理画面から対象リストを確認し、「**論理削除**」または「**匿名化**」を選択して実行できる。
  - `[ ]` **論理削除:** データはDB上に残存するが、`deleted_at`カラムにタイムスタンプが記録され、通常のUIからは一切参照できなくなる。法的要請など、特別な場合にのみDBから復元可能。
  - `[ ]` **匿名化:** 氏名、住所、電話番号、メールアドレスなどのPIIを、復元不可能なランダムな文字列に置換する。統計分析などの目的で、個人と切り離された活動履歴データのみを残す場合に用いる。
  - `[ ]` ユーザーが誤って操作した場合を考慮し、確認ダイアログでは論理削除を推奨するUIとする。物理削除は実装しない。
- `[ ]` **【タスク通知】** 担当者に割り当てられたタスクの期日が近づくと、通知が送信される。
  - `[ ]` **配信チャネル:** 通知は、まず**システム内の通知センター**に送信されることを第一優先とする。
  - `[ ]` ユーザーがメール通知を有効にしている場合は、システム内通知に加えて、登録メールアドレスにも通知が送信される。 