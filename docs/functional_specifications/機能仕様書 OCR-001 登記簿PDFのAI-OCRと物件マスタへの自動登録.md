### **機能仕様書 v1.1**

**機能ID:** `OCR-001` **機能名:** `登記簿PDFのAI-OCRと物件マスタへの自動登録`

#### **1\. 概要（Overview）**

ユーザーがアップロードした登記簿謄本（PDF）をAIが解析し、その内容を物件マスタ・データベースへ自動的に登録する機能。これにより、現場の「手入力」という最大のペインポイントを解消する。

#### **2\. 前提条件**

* **サポート対象PDF:** 本機能は**PDF 1.5以上、推奨300dpi、最低200dpi**の解像度で作成されたデジタル形式のドキュメントをサポート対象とする。著しく品質の低いスキャンデータや、古い形式のPDFは「サポート対象外」とする。

#### **3\. ユーザーゴール（User Story）**

**`broker_agent`（仲介担当者）または `legal_staff`（法務・契約担当）として、** 私は **登記簿PDFをドラッグ＆ドロップするだけで物件情報を登録したい。** それによって、**手入力の時間を99%削減し、入力ミスをなくしたい。**

#### **4\. 受入基準（Acceptance Criteria）**

* `[ ]` ユーザーは、指定されたエリアに単一のPDFファイルをドラッグ＆ドロップ、またはファイル選択ダイアログからアップロードできる。
* `[ ]` **【前処理】** アップロードされたPDFの解像度が低い（300dpi未満）場合、OCR処理の前に自動でリサイズやシャープ化などの画像強調処理を行う。
* `[ ]` アップロード中は、処理中であることが分かるプログレスバーまたはローディングインジケーターが表示される。
* `[ ]` システム仕様書で定義された主要15項目が、95%以上のフィールド正答率で抽出される。
* `[ ]` AIによる読み取り信頼度が95%未満の項目は、黄色くハイライトされ、ユーザーに目視確認を促す。
* `[ ]` サポート対象外と判定された箇所（例：手書き備考欄）は、フォーム上でグレーアウトまたは「手動入力してください」といった案内が表示される。
* `[ ]` ユーザーは、AIによって自動入力された全ての項目を、画面上で手動で修正・上書きできる。
* `[ ]` 「物件情報を登録する」ボタンをクリックすると、画面上のデータが物件マスタ・データベースに正しく保存される。

#### **5\. UIデザインとUXフロー**

* **5.1. 画面デザイン:**  
  * 本機能に関わる画面の高忠実度モックアップは、以下のFigmaリンクにて定義する。  
  * **\[Figmaモックアップへのリンク（※作成後、ここにURLを記載）\]**  
* **5.2. ユーザーフロー図:**  
  * ダッシュボード → 物件登録ボタン → **OCRアップロード画面** → 確認・修正画面 → 登録完了  
* **5.3. インタラクション:**  
  * PDFファイルをドラッグしてアップロードエリアに重ねると、エリアの枠線が青く点滅する。  
  * 「登録」ボタン押下後、処理が完了するまではボタンを無効化し、ローディングスピナーを表示する。

#### **6\. システム要件（バックエンド）**

* **6.1. APIエンドポイント:**  
  1. `POST /api/v1/properties/ocr`  
  2. `GET /api/v1/properties/ocr/status/{job_id}`  
* **6.2. データ処理フロー:**  
  1. フロントエンドからPDFファイルを受領し、S3等のストレージに保存。  
  2. AI WorkerにOCR処理ジョブを非同期で依頼。  
  3. AI WorkerはGPT-4o Vision API等を呼び出し、PDFを解析。  
  4. **【機微情報マスク】** OCR処理の過程で、個人番号や口座番号などの機微情報が検知された場合、データベース保存前に自動でマスク処理を行う。  
  5. 結果（JSON）をデータベースに一時保存し、処理ステータスを「完了」に更新。  
  6. **【再学習ループ】** ユーザーが手動で修正した項目は、「ユーザー修正済み」のタグと共に、再学習用データとして別途S3バケットに保管する。このデータは月次のモデル微調整（ファインチューニング）に活用する。

#### **7\. パフォーマンス要件**

- `[ ]` **【応答性能】** PDFアップロード後、60秒以内にOCR処理が完了し、結果が画面に反映される。
- `[ ]` **【スループット】** 同時に10件のPDFファイルをアップロードした場合、全体の処理が3分以内に完了する。
- `[ ]` **【水平スケーリング】** 上記性能を維持するため、OCR処理を行うAI Workerは負荷に応じて自動的にスケールアウト／インする。
  - **基準値（例）:**
    - **通常時:** 2ワーカーが常時稼働。
    - **スケールアウト:** 処理待ちキューの長さが**5件**を超えた場合、ワーカーを1つ追加（最大10ワーカーまで）。
    - **スケールイン:** 15分間、CPU使用率が10%未満のワーカーが存在する場合、そのワーカーを削減。
- `[ ]` **【キューイング】** 同時実行上限（10ジョブ）を超えてリクエストがあった場合、後続のジョブはリジェクトせず、キューイングシステム（例: SQS）に積まれ、順次処理される。

#### **8\. セキュリティ要件**

- `[ ]` **【アップロードファイルの検証】** アップロードされたファイルは、バックエンドでファイルタイプとサイズが検証され、PDF形式以外または100MBを超えるファイルは拒否される。
- `[ ]` **【保管時の暗号化】** アップロードされたPDFおよび生成された中間データは、保管時に**サーバーサイド暗号化（SSE-S3）**を用いて自動的に暗号化される。
- `[ ]` **【アクセス制御】** `AUTH-001`で定義されたロールに基づき、ファイルへのアクセスを制御する。
    - `[ ]` `broker_agent`および`legal_staff`ロールを持つユーザーは、自身がアップロードしたファイルにのみアクセスできる。
    - `[ ]` `tenant_admin`ロールを持つユーザーは、自身が所属する組織（テナント）内の全ユーザーがアップロードしたファイルにアクセスできる。

#### **9\. エラーハンドリング**

| エラーケース                       | エラーメッセージ例                                     | 対応                                                               |
| :----                              | :----                                                  | :----                                                               |
| **パスワードで保護されたPDF**       | 「このPDFはパスワードで保護されているため、処理できません。」 | ユーザーにパスワードを解除するよう指示し、再アップロードを促す。     |
| **サポート対象外のファイル形式・画質** | 「対応しているファイル形式はPDFのみです。200dpi以上の解像度を推奨します。」 | ユーザーにサポート対象のファイル形式と画質要件を確認し、再アップロードを促す。 |
| **AIサーバーのタイムアウト**       | 「現在サーバーが混み合っています。時間をおいて再度お試しください。」 | ユーザーにしばらく待ってから再試行するよう指示する。                   |

---

#### **10. RC版（Release Candidate）要件**

**目標**: 商用環境での高精度・高スループットOCR処理システム

##### **10.1. 精度・品質向上**
- `[ ]` **認識精度向上**: 主要15項目で98%以上のフィールド正答率
- `[ ]` **信頼度算出**: 各項目の認識信頼度を5段階で詳細表示
- `[ ]` **前処理強化**: 低解像度・傾き・ノイズ補正の自動最適化
- `[ ]` **学習データ拡充**: 月次ファインチューニングでの継続的精度向上

##### **10.2. パフォーマンス・スケーラビリティ**
- `[ ]` **処理時間短縮**: OCR処理完了まで30秒以内（99パーセンタイル）
- `[ ]` **同時処理能力**: 50件以上の同時OCRジョブ処理対応
- `[ ]` **Auto Scaling**: 負荷に応じた動的ワーカースケーリング最適化
- `[ ]` **キューイング管理**: 処理待ちキューの優先度制御・見積もり時間表示

##### **10.3. セキュリティ・プライバシー**
- `[ ]` **機微情報検知**: 個人番号・口座情報の高精度自動検知・マスク
- `[ ]` **データ暗号化**: OCR処理パイプライン全体でのE2E暗号化
- `[ ]` **アクセス監査**: OCR処理実行・結果アクセスの完全ログ記録
- `[ ]` **データ保持期間**: 処理済みPDF・中間データの自動削除ポリシー

##### **10.4. AI/ML基盤強化**
- `[ ]` **マルチモデル対応**: GPT-4V以外のOCRモデル（Vertex AI等）対応
- `[ ]` **フィードバックループ**: ユーザー修正データの自動学習データ化
- `[ ]` **A/Bテスト**: 複数AIモデルでの精度比較・最適モデル選択
- `[ ]` **エッジケース対応**: 手書き・汚損・複雑レイアウト対応強化

##### **10.5. 成功基準**
- **認識精度**: 主要項目98%以上の正答率
- **処理時間**: 95パーセンタイルで30秒以内
- **稼働率**: 99.8%以上（AI API依存含む）
- **ユーザー満足度**: 4.4/5.0以上（OCR機能特化評価）

