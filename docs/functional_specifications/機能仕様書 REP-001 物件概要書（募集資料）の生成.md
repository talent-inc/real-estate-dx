### **機能仕様書 v1.1**

**機能ID:** `REP-001`
**機能名:** `物件概要書（募集資料）の生成`

#### **1. 概要（Overview）**

`Unified Form`(UF-001)に入力された物件情報、写真、図面データを基に、デザイン性の高い物件概要書（募集資料、通称：マイソク）をPDF形式で生成・出力する機能。固定的フォーマットの帳票では表現できない、各社のブランディングや物件の魅力に合わせた、訴求力の高い資料作成を可能にすることを目的とする。

#### **2. ユーザーゴール（User Story）**

**`broker_agent`（仲介担当者）として、** 私は **テンプレートを選び、いくつかの項目を調整するだけで、顧客の目を引くような美しい物件概要書を素早く作成したい。** それによって、**資料作成の手間を省き、物件の魅力を最大限に伝えたい。**

#### **3. 受入基準（Acceptance Criteria）**

- `[ ]` `Unified Form`に入力済みのデータ（物件情報、価格、コメント等）が、生成される概要書の該当箇所に自動で反映される。
- `[ ]` **【テンプレート選択】** 用途やデザインテイストが異なる、複数の概要書テンプレート（例：「シンプル」「モダン」「ファミリー向け」など）から選択できる。
- `[ ]` **【カスタマイズ機能】** ユーザーは、選択したテンプレートに対し、以下の項目をカスタマイズできる。
  - `[ ]` 表示する写真の選択とレイアウト（例：メイン写真を大きく、サブ写真を3点掲載）。
  - `[ ]` 間取り図の表示/非表示、およびサイズの調整。
  - `[ ]` 表示項目の選択（例：「固定資産税評価額」は非表示にする）。
  - `[ ]` 強調したいキャッチコピーやアピールポイントの自由入力。
  - `[ ]` 自社のロゴ画像のアップロードと表示。
- `[ ]` **【プレビュー機能】** PDFを生成する前に、画面上で仕上がりイメージをリアルタイムにプレビューできる。
- `[ ]` **【PDF出力】** 「PDF生成」ボタンをクリックすると、プレビュー通りの内容で高品質なPDFファイルが生成・ダウンロードされる。
- `[ ]` 生成されたPDFは、印刷しても文字や写真が鮮明であること（300dpi相当）。

#### **4. UIデザインとUXフロー**

- **4.1. 画面デザイン:**
  - 画面を左右に分割したエディタ形式を想定。
  - **左側：** テンプレート選択、表示項目設定、テキスト編集などのカスタマイズ用コントロールパネル。
  - **右側：** 変更がリアルタイムに反映されるプレビューエリア。
  - **[Figmaモックアップへのリンク（※作成後、ここにURLを記載）]**
- **4.2. ユーザーフロー図:**
  1. 案件詳細画面にて、「物件概要書を作成」ボタンをクリック。
  2. 概要書作成画面に遷移。
  3. ユーザーはまず、ベースとなるテンプレートを選択する。
  4. 左側のパネルで写真や項目、テキストなどをカスタマイズする。
  5. 右側のプレビューで仕上がりを確認しながら調整を行う。
  6. 「PDFを生成」ボタンをクリックし、ファイルをダウンロードする。

#### **5. システム要件（バックエンド）**

- **5.1. APIエンドポイント:**
  - `GET /api/v1/properties/{property_id}/flyer-templates` (利用可能なテンプレート一覧の取得)
  - `POST /api/v1/properties/{property_id}/flyer` (指定されたテンプレートとデータでPDFを生成)
- **5.2. PDF生成エンジン:**
  - バックエンドでHTMLテンプレートと物件データを組み合わせ、HTMLをレンダリングする。
  - PuppeteerやWeasyPrintなどのライブラリを使用し、レンダリングされたHTMLをPDFに変換する。
  - CSSの`@media print`ルールを駆使し、Webプレビューと印刷結果の整合性を担保する。
- **5.3. テンプレート管理:**
  - PDFのレイアウトを定義するテンプレート（HTML/CSS）は、バージョン管理されたファイルとしてシステム外部で管理する。これにより、開発者のデプロイ作業なしに新しいテンプレートの追加や修正が可能になる。
  - `[ ]` **フォントライセンス:** テンプレートで使用するカスタムフォントは、**商用利用が許可された**OpenType(.otf)またはTrueType(.ttf)フォントに限定する。アップロード時には、ライセンス情報の申告を必須とし、記録する。
- **5.4. パフォーマンス要件:**
  - ユーザーがカスタマイズ操作を行ってから、プレビューが更新されるまでの時間は1秒以内であること。
  - 「PDF生成」ボタンクリック後、15秒以内にダウンロードが開始されること。
- **5.5. 制約事項・品質要件:**
  - **【画像仕様】** アップロード可能な画像のファイル形式はJPEG, PNG, HEIFとする。ファイルサイズは最大**10MB**まで、解像度は**4096x4096ピクセル**までとする。これを超える画像は、アップロード時に自動的にリサイズされる。
  - **【テスト基準】** テンプレートの変更をテストする際は、Webプレビューと生成されたPDFのレンダリング結果を比較するビジュアルリグレッションテストを行う。両者のピクセル単位での差分が**3%未満**である場合を合格（Pass）とする。

#### **6. エラーハンドリング**

| エラーケース | ユーザーへの表示（フロントエンド） | システムの挙動（バックエンド） |
| :--- | :--- | :--- |
| **必須データ（住所・価格等）の不足** | 「物件の基本情報が不足しているため、概要書を作成できません。物件情報を更新してください。」 | APIはバリデーションエラー（422）を返す。 |
| **PDF生成エンジンのエラー** | 「PDFの生成中にエラーが発生しました。時間をおいて再度お試しください。」 | エラーをログに記録し、APIはエラーステータス（500）を返す。 |
| **大きすぎる画像のアップロード** | 「画像のファイルサイズが10MBを超えています。ファイルサイズを圧縮するか、別の画像をアップロードしてください。」 | フロントエンドおよびバックエンドでファイルサイズを検証し、上限を超える場合はエラーを返す。 |

#### **7. 法的要件**

- `[ ]` **【フォントライセンス】** 生成されるPDFで使用するフォントは、**商用利用可能**で、ライセンスが明記されたオープンソースフォント（例: Noto Sans JP, M PLUS 1p）または、正式に契約した有料フォントのみとする。
- `[ ]` **【画像の取り扱い】** ユーザーがアップロードした物件写真以外のロゴやアイコンなどの画像素材は、商用利用可能なフリー素材、または自社で権利を保有するもののみを使用する。

#### **8. 将来の展望（バックログ）**

- `[ ]` **【アクセシビリティ対応 (PDF/UA)】**
  - 将来的なバージョンで、生成されるPDFがスクリーンリーダー等での読み上げに対応できるよう、PDF/UA (Universal Accessibility) 標準に準拠することを目指す。
  - 具体的には、PDF内の要素（見出し、段落、画像、表）に適切なタグを付与し、読み上げ順序が論理的になるように構造化する。

- `[ ]` **【多言語対応】**

#### **9. RC版（Release Candidate）要件**

**目標**: プロダクション環境での高品質なPDF生成・大量処理対応

##### **9.1. パフォーマンス・スケーラビリティ**
- `[ ]` **大量生成対応**: 同時100件以上のPDF生成リクエストでの安定処理
- `[ ]` **応答時間最適化**: PDF生成完了まで10秒以内（A4サイズ、8ページ以内）
- `[ ]` **リソース効率化**: Cloud Runでのメモリ・CPU使用量最適化
- `[ ]` **ストレージ管理**: 生成済みPDFの自動キャッシュ・有効期限管理

##### **9.2. 品質・信頼性向上**
- `[ ]` **ビジュアル品質**: 印刷時の解像度300dpi以上保証
- `[ ]` **フォント最適化**: 商用利用可能フォントの完全ライセンス確認
- `[ ]` **レイアウト堅牢性**: 多様なデータパターンでのレイアウト崩れ防止
- `[ ]` **テンプレート検証**: 全テンプレートのビジュアルリグレッションテスト自動化

##### **9.3. セキュリティ・コンプライアンス**
- `[ ]` **ウォーターマーク**: 未承認利用防止のためのウォーターマーク機能
- `[ ]` **アクセス制御**: PDF生成履歴・アクセスログの完全監査
- `[ ]` **データ暗号化**: PDF生成プロセス全体での暗号化通信
- `[ ]` **個人情報保護**: 機微情報の自動マスク・匿名化オプション

##### **9.4. 運用・保守性**
- `[ ]` **エラー監視**: PDF生成失敗率・応答時間のリアルタイム監視
- `[ ]` **テンプレート管理**: 非技術者によるテンプレート更新UI
- `[ ]` **バックアップ・復旧**: カスタマイズ設定・テンプレートのバックアップ機能
- `[ ]` **ログ分析**: 利用パターン分析・人気テンプレート特定

##### **9.5. 成功基準**
- **PDF生成成功率**: 99.5%以上
- **応答時間**: 95パーセンタイルで10秒以内
- **品質評価**: ユーザー満足度4.3/5.0以上
- **セキュリティ**: 脆弱性検査での重大リスク0件